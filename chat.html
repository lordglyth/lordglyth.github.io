// Add a message to the chat history
function addMessage(role, content) {
    const messageElem = document.createElement("div");
    messageElem.className = "message " + (role === "user" ? "user" : "assistant");
    messageElem.innerHTML = `<b>${role === "user" ? "👤 user:" : "🤖 assistant:"}</b> ${content}`;
    chatHistory.appendChild(messageElem);
    chatHistory.scrollTop = chatHistory.scrollHeight;
}

// Send message to the server
function sendMessage() {
    const userMessage = document.getElementById("userInput").value.trim();
    if (!userMessage) return;

    addMessage("user", userMessage);
    messageHistory.push({ role: "user", content: userMessage });
    saveMessages();

    document.getElementById("userInput").value = "";

    fetch(workerURL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            messages: messageHistory
        })
    })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status} - ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.choices && data.choices.length > 0) {
                const botMessage = data.choices[0].message.content;
                addMessage("assistant", botMessage);  // Use "assistant" instead of "bot"
                messageHistory.push({ role: "assistant", content: botMessage });  // Use "assistant" instead of "bot"
                saveMessages();
            } else {
                addMessage("error", "❌ Error: No response from ChatGPT.");
            }
        })
        .catch(error => {
            addMessage("error", `❌ Error: ${error.message}`);
            console.error("Error:", error);
        });
}
